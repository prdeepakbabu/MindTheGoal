<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - MindTheGoal</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <nav class="navbar">
        <a href="/dashboard" class="nav-brand">
            <div class="nav-logo">üéØ</div>
            MindTheGoal
        </a>
        <div class="nav-links">
            <a href="/evaluate" class="nav-link">Run Evaluation</a>
            <a href="/dashboard" class="nav-link">Dashboard</a>
            <a href="/chat" class="nav-link">Chat Demo</a>
            <a href="/settings" class="nav-link active">Settings</a>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">‚öôÔ∏è Settings</h1>
            <p class="page-subtitle">Configure RCOF categories and evaluation parameters</p>
        </div>

        <!-- Tabs -->
        <div class="tabs" style="max-width: 400px;">
            <button class="tab active" onclick="switchTab('rcof')">RCOF Categories</button>
            <button class="tab" onclick="switchTab('general')">General</button>
        </div>

        <!-- RCOF Categories Tab -->
        <div id="rcofTab">
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="card-title">Root Cause of Failure (RCOF) Categories</h2>
                    <button class="btn btn-primary btn-sm" onclick="addCategory()">
                        <span>+</span> Add Category
                    </button>
                </div>
                <p class="text-muted mb-4">
                    Customize failure categories used for classifying why agent responses fail. 
                    Changes will update the judge prompts used during evaluation.
                </p>
                
                <div id="rcofCategories">
                    <div class="empty-state">
                        <div class="loading-spinner"></div>
                        <p class="mt-2">Loading categories...</p>
                    </div>
                </div>
            </div>

            <div class="flex gap-3">
                <button class="btn btn-primary" onclick="saveCategories()">
                    üíæ Save Changes
                </button>
                <button class="btn btn-secondary" onclick="resetToDefaults()">
                    üîÑ Reset to Defaults
                </button>
                <button class="btn btn-secondary" onclick="exportConfig()">
                    üì§ Export Config
                </button>
                <label class="btn btn-secondary" style="cursor: pointer;">
                    üì• Import Config
                    <input type="file" accept=".json" onchange="importConfig(event)" style="display: none;">
                </label>
            </div>
        </div>

        <!-- General Settings Tab -->
        <div id="generalTab" style="display: none;">
            <div class="card">
                <h2 class="card-title" style="margin-bottom: 1.5rem;">General Settings</h2>
                
                <div class="form-group">
                    <label class="form-label">API Base URL</label>
                    <input type="text" id="apiBaseUrl" class="form-input" value="http://localhost:8000/api">
                    <p class="form-hint">Base URL for the MindTheGoal API server</p>
                </div>

                <div class="form-group">
                    <label class="form-label">Default Sample Size</label>
                    <input type="number" id="defaultSampleSize" class="form-input" value="100">
                    <p class="form-hint">Default number of dialogues to evaluate</p>
                </div>

                <div class="form-group">
                    <label class="form-label">Request Delay (seconds)</label>
                    <input type="number" id="requestDelay" class="form-input" value="10" step="1" min="0">
                    <p class="form-hint">Delay between API requests to avoid rate limiting</p>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="enableCheckpoints" checked> Enable Checkpointing
                    </label>
                    <p class="form-hint">Save progress during long evaluations for recovery</p>
                </div>

                <button class="btn btn-primary" onclick="saveGeneralSettings()">
                    üíæ Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Edit Category</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editCode">
                
                <div class="form-group">
                    <label class="form-label">Code</label>
                    <input type="text" id="editNewCode" class="form-input" placeholder="E8" maxlength="3">
                    <p class="form-hint">Short code like E1, E2, etc.</p>
                </div>

                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" id="editName" class="form-input" placeholder="Category Name">
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="editDescription" class="form-input" rows="2" placeholder="Brief description of when this category applies"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Examples (one per line)</label>
                    <textarea id="editExamples" class="form-input" rows="3" placeholder="Example 1&#10;Example 2&#10;Example 3"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Keywords (comma-separated)</label>
                    <input type="text" id="editKeywords" class="form-input" placeholder="keyword1, keyword2, keyword3">
                </div>

                <div class="form-group">
                    <label class="form-label">Color</label>
                    <div class="flex gap-2 items-center">
                        <input type="color" id="editColor" value="#ef4444" style="width: 50px; height: 40px; border: none; cursor: pointer;">
                        <input type="text" id="editColorHex" class="form-input" style="width: 120px;" placeholder="#ef4444">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="editEnabled" checked> Enabled
                    </label>
                    <p class="form-hint">Disabled categories won't be used in evaluations</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveCategory()">Save</button>
            </div>
        </div>
    </div>

    <script>
        let rcofConfig = null;
        const CONFIG_PATH = '/static/config/rcof_config.json';

        async function loadConfig() {
            try {
                const response = await fetch(CONFIG_PATH);
                rcofConfig = await response.json();
                renderCategories();
            } catch (error) {
                console.error('Error loading config:', error);
                // Use defaults
                rcofConfig = getDefaultConfig();
                renderCategories();
            }
        }

        function getDefaultConfig() {
            return {
                version: "1.0",
                categories: {
                    "E1": { code: "E1", name: "Language Understanding Failure", description: "Misunderstood user's request or context", examples: [], keywords: [], enabled: true, color: "#ef4444" },
                    "E2": { code: "E2", name: "Refusal to Answer", description: "Inappropriate refusal despite ability to help", examples: [], keywords: [], enabled: true, color: "#f59e0b" },
                    "E3": { code: "E3", name: "Incorrect Retrieval", description: "Retrieved wrong informational content", examples: [], keywords: [], enabled: true, color: "#ec4899" },
                    "E4": { code: "E4", name: "Retrieval Failure", description: "Failed to retrieve any relevant information", examples: [], keywords: [], enabled: true, color: "#8b5cf6" },
                    "E5": { code: "E5", name: "System Error", description: "Technical issues (timeout, truncation, integration failure)", examples: [], keywords: [], enabled: true, color: "#3b82f6" },
                    "E6": { code: "E6", name: "Incorrect Routing", description: "Query routed to wrong domain/module", examples: [], keywords: [], enabled: true, color: "#14b8a6" },
                    "E7": { code: "E7", name: "Out-of-Domain", description: "Request outside system's designed scope", examples: [], keywords: [], enabled: true, color: "#6b7280" }
                }
            };
        }

        function renderCategories() {
            const container = document.getElementById('rcofCategories');
            const categories = Object.values(rcofConfig.categories);
            
            if (categories.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-title">No categories defined</div>
                        <p class="text-muted">Add your first RCOF category to get started</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = categories.map(cat => `
                <div class="metric-card ${!cat.enabled ? 'opacity-50' : ''}" style="margin-bottom: 1rem; border-left: 4px solid ${cat.color};">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="rcof-tag" style="background: ${cat.color}20; color: ${cat.color};">${cat.code}</span>
                            <div>
                                <div style="font-weight: 600;">${cat.name}</div>
                                <div class="text-muted" style="font-size: 0.875rem;">${cat.description}</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-sm btn-secondary" onclick="editCategory('${cat.code}')">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="toggleCategory('${cat.code}')" title="${cat.enabled ? 'Disable' : 'Enable'}">
                                ${cat.enabled ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCategory('${cat.code}')" title="Delete">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    ${cat.examples && cat.examples.length > 0 ? `
                        <div class="mt-3" style="font-size: 0.75rem;">
                            <strong class="text-muted">Examples:</strong>
                            <ul style="margin: 0.5rem 0 0 1rem; color: var(--text-muted);">
                                ${cat.examples.slice(0, 2).map(ex => `<li>${ex}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('rcofTab').style.display = tab === 'rcof' ? 'block' : 'none';
            document.getElementById('generalTab').style.display = tab === 'general' ? 'block' : 'none';
        }

        function addCategory() {
            document.getElementById('modalTitle').textContent = 'Add New Category';
            document.getElementById('editCode').value = '';
            document.getElementById('editNewCode').value = '';
            document.getElementById('editName').value = '';
            document.getElementById('editDescription').value = '';
            document.getElementById('editExamples').value = '';
            document.getElementById('editKeywords').value = '';
            document.getElementById('editColor').value = '#6b7280';
            document.getElementById('editColorHex').value = '#6b7280';
            document.getElementById('editEnabled').checked = true;
            document.getElementById('editNewCode').disabled = false;
            
            document.getElementById('editModal').classList.add('active');
        }

        function editCategory(code) {
            const cat = rcofConfig.categories[code];
            if (!cat) return;

            document.getElementById('modalTitle').textContent = `Edit ${code}`;
            document.getElementById('editCode').value = code;
            document.getElementById('editNewCode').value = code;
            document.getElementById('editNewCode').disabled = true;
            document.getElementById('editName').value = cat.name;
            document.getElementById('editDescription').value = cat.description;
            document.getElementById('editExamples').value = (cat.examples || []).join('\n');
            document.getElementById('editKeywords').value = (cat.keywords || []).join(', ');
            document.getElementById('editColor').value = cat.color;
            document.getElementById('editColorHex').value = cat.color;
            document.getElementById('editEnabled').checked = cat.enabled;
            
            document.getElementById('editModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        function saveCategory() {
            const originalCode = document.getElementById('editCode').value;
            const code = document.getElementById('editNewCode').value.toUpperCase();
            const name = document.getElementById('editName').value;
            const description = document.getElementById('editDescription').value;
            const examples = document.getElementById('editExamples').value.split('\n').filter(e => e.trim());
            const keywords = document.getElementById('editKeywords').value.split(',').map(k => k.trim()).filter(k => k);
            const color = document.getElementById('editColor').value;
            const enabled = document.getElementById('editEnabled').checked;

            if (!code || !name) {
                alert('Code and Name are required');
                return;
            }

            // Remove old code if editing
            if (originalCode && originalCode !== code) {
                delete rcofConfig.categories[originalCode];
            }

            rcofConfig.categories[code] = {
                code, name, description, examples, keywords, color, enabled
            };

            renderCategories();
            closeModal();
        }

        function deleteCategory(code) {
            if (!confirm(`Delete category ${code}? This cannot be undone.`)) return;
            delete rcofConfig.categories[code];
            renderCategories();
        }

        function toggleCategory(code) {
            rcofConfig.categories[code].enabled = !rcofConfig.categories[code].enabled;
            renderCategories();
        }

        async function saveCategories() {
            try {
                // In a real app, this would POST to an API
                // For now, we'll download the config
                const blob = new Blob([JSON.stringify(rcofConfig, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'rcof_config.json';
                a.click();
                URL.revokeObjectURL(url);
                
                alert('Config downloaded! Replace config/rcof_config.json with this file.');
            } catch (error) {
                alert('Error saving config: ' + error.message);
            }
        }

        function resetToDefaults() {
            if (!confirm('Reset all categories to defaults? Custom categories will be lost.')) return;
            rcofConfig = getDefaultConfig();
            renderCategories();
        }

        function exportConfig() {
            const blob = new Blob([JSON.stringify(rcofConfig, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'rcof_config_export.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.categories) {
                        rcofConfig = imported;
                        renderCategories();
                        alert('Config imported successfully!');
                    } else {
                        alert('Invalid config file format');
                    }
                } catch (error) {
                    alert('Error parsing config file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function saveGeneralSettings() {
            const settings = {
                apiBaseUrl: document.getElementById('apiBaseUrl').value,
                defaultSampleSize: parseInt(document.getElementById('defaultSampleSize').value),
                requestDelay: parseInt(document.getElementById('requestDelay').value),
                enableCheckpoints: document.getElementById('enableCheckpoints').checked
            };
            
            localStorage.setItem('mindthegoal_settings', JSON.stringify(settings));
            alert('Settings saved!');
        }

        function loadGeneralSettings() {
            const saved = localStorage.getItem('mindthegoal_settings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('apiBaseUrl').value = settings.apiBaseUrl || 'http://localhost:8000/api';
                document.getElementById('defaultSampleSize').value = settings.defaultSampleSize || 100;
                document.getElementById('requestDelay').value = settings.requestDelay || 10;
                document.getElementById('enableCheckpoints').checked = settings.enableCheckpoints !== false;
            }
        }

        // Sync color picker with hex input
        document.getElementById('editColor').addEventListener('input', (e) => {
            document.getElementById('editColorHex').value = e.target.value;
        });
        document.getElementById('editColorHex').addEventListener('input', (e) => {
            if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
                document.getElementById('editColor').value = e.target.value;
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            loadGeneralSettings();
        });
    </script>
</body>
</html>
